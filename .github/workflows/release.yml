name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: 1.24.0

    - name: Cache Go modules
      uses: actions/cache@v4
      with:
        path: ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: Get version from tag
      id: version
      run: |
        VERSION=${GITHUB_REF#refs/tags/}
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "VERSION_NO_V=${VERSION#v}" >> $GITHUB_OUTPUT
        echo "Building version: $VERSION"

    - name: Install dependencies
      run: go mod download

    - name: Run tests
      run: |
        make test
        make test-prop

    - name: Build binaries
      env:
        VERSION: ${{ steps.version.outputs.VERSION }}
        VERSION_NO_V: ${{ steps.version.outputs.VERSION_NO_V }}
        CGO_ENABLED: 0
      run: |
        mkdir -p dist
        
        # Set version in build (inject into main.version variable)
        LDFLAGS="-s -w -X main.version=${VERSION_NO_V}"
        
        echo "Building with LDFLAGS: $LDFLAGS"
        echo "CGO_ENABLED: $CGO_ENABLED"
        
        # Linux
        echo "Building Linux AMD64..."
        GOOS=linux GOARCH=amd64 go build -ldflags="${LDFLAGS}" -o dist/deadman-go-linux-amd64 .
        echo "Building Linux ARM64..."
        GOOS=linux GOARCH=arm64 go build -ldflags="${LDFLAGS}" -o dist/deadman-go-linux-arm64 .
        
        # macOS
        echo "Building macOS AMD64..."
        GOOS=darwin GOARCH=amd64 go build -ldflags="${LDFLAGS}" -o dist/deadman-go-darwin-amd64 .
        echo "Building macOS ARM64..."
        GOOS=darwin GOARCH=arm64 go build -ldflags="${LDFLAGS}" -o dist/deadman-go-darwin-arm64 .
        
        # Windows
        echo "Building Windows AMD64..."
        GOOS=windows GOARCH=amd64 go build -ldflags="${LDFLAGS}" -o dist/deadman-go-windows-amd64.exe .
        
        # Verify builds
        echo "Built files:"
        ls -la dist/
        
        # Verify file types
        echo "File types:"
        file dist/*

    - name: Test binaries
      run: |
        echo "Testing Linux binary..."
        ./dist/deadman-go-linux-amd64 -version
        echo "Testing macOS binary..."
        ./dist/deadman-go-darwin-amd64 -version

    - name: Create checksums
      run: |
        cd dist
        sha256sum * > checksums.txt
        echo "Checksums created:"
        cat checksums.txt

    - name: Create release notes
      env:
        VERSION: ${{ steps.version.outputs.VERSION }}
      run: |
        cat > release_notes.md << EOF
        # deadman-go ${VERSION}
        
        A Go implementation of the deadman ping monitoring tool, providing efficient host status monitoring with a terminal-based interface.
        
        ## What's New in ${VERSION}
        
        $(if [ "${VERSION}" = "v0.0.1" ]; then
          echo "ðŸŽ‰ **Initial Release**"
          echo ""
          echo "- Go implementation of deadman ping monitoring tool"
          echo "- Configuration compatibility with original deadman"
          echo "- Terminal UI with real-time status display and RTT bar graphs"
          echo "- Concurrent ping monitoring with configurable limits"
          echo "- Prometheus metrics export support"
          echo "- Cross-platform support (Linux, macOS, Windows)"
          echo "- Single binary distribution with no dependencies"
        else
          echo "See [CHANGELOG.md](https://github.com/doridoridoriand/deadman-go/blob/main/CHANGELOG.md) for detailed changes."
        fi)
        
        ## Installation
        
        ### Quick Install (Linux/macOS)
        
        \`\`\`bash
        # Linux AMD64
        curl -L https://github.com/doridoridoriand/deadman-go/releases/download/${VERSION}/deadman-go-linux-amd64 -o deadman-go
        chmod +x deadman-go
        sudo mv deadman-go /usr/local/bin/
        
        # macOS (Intel)
        curl -L https://github.com/doridoridoriand/deadman-go/releases/download/${VERSION}/deadman-go-darwin-amd64 -o deadman-go
        chmod +x deadman-go
        sudo mv deadman-go /usr/local/bin/
        
        # macOS (Apple Silicon)
        curl -L https://github.com/doridoridoriand/deadman-go/releases/download/${VERSION}/deadman-go-darwin-arm64 -o deadman-go
        chmod +x deadman-go
        sudo mv deadman-go /usr/local/bin/
        \`\`\`
        
        ### Manual Download
        
        Download the appropriate binary for your platform from the assets below:
        
        | Platform | Architecture | Binary |
        |----------|-------------|---------|
        | Linux | AMD64 | \`deadman-go-linux-amd64\` |
        | Linux | ARM64 | \`deadman-go-linux-arm64\` |
        | macOS | Intel | \`deadman-go-darwin-amd64\` |
        | macOS | Apple Silicon | \`deadman-go-darwin-arm64\` |
        | Windows | AMD64 | \`deadman-go-windows-amd64.exe\` |
        
        ### Verify Installation
        
        \`\`\`bash
        deadman-go -version
        \`\`\`
        
        ## Quick Start
        
        1. Create a configuration file:
        \`\`\`conf
        # deadman-go: interval=2s timeout=1s max_concurrency=50
        google 8.8.8.8
        cloudflare 1.1.1.1
        ---
        router 192.168.1.1
        \`\`\`
        
        2. Run deadman-go:
        \`\`\`bash
        deadman-go config.conf
        \`\`\`
        
        ## Documentation
        
        - [README](https://github.com/doridoridoriand/deadman-go/blob/main/README.md) - Complete documentation
        - [Configuration Guide](https://github.com/doridoridoriand/deadman-go/blob/main/README.md#configuration-reference) - Detailed configuration options
        - [Contributing](https://github.com/doridoridoriand/deadman-go/blob/main/CONTRIBUTING.md) - How to contribute
        
        ## Checksums
        
        \`\`\`
        $(cat dist/checksums.txt)
        \`\`\`
        
        ---
        
        **Note**: This project is inspired by and maintains compatibility with the original [deadman](https://github.com/upa/deadman) tool by [upa](https://github.com/upa).
        EOF

    - name: Create release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          dist/*
        body_path: release_notes.md
        draft: false
        prerelease: ${{ contains(steps.version.outputs.VERSION, 'alpha') || contains(steps.version.outputs.VERSION, 'beta') || contains(steps.version.outputs.VERSION, 'rc') }}
        make_latest: true
        tag_name: ${{ steps.version.outputs.VERSION }}
        name: "deadman-go ${{ steps.version.outputs.VERSION }}"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Summary
      run: |
        echo "ðŸŽ‰ Release ${{ steps.version.outputs.VERSION }} created successfully!"
        echo "ðŸ“¦ Binaries built for Linux, macOS, and Windows"
        echo "ðŸ”— Release URL: https://github.com/doridoridoriand/deadman-go/releases/tag/${{ steps.version.outputs.VERSION }}"