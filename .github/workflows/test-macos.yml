name: Test macOS Compatibility

on:
  workflow_dispatch:
  pull_request:
    paths:
      - '**.go'
      - 'go.mod'
      - 'go.sum'
      - '.github/workflows/test-macos.yml'

jobs:
  test-macos:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: 1.24.0

    - name: Cache Go modules
      uses: actions/cache@v4
      with:
        path: ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: Install dependencies
      run: go mod download

    - name: Run tests on macOS
      run: |
        make test
        make test-prop

    - name: Build native macOS binary
      run: |
        make build
        ./bin/deadman-go -version

    - name: Test ICMP functionality (requires sudo)
      run: |
        # Test external ping fallback (doesn't require sudo)
        echo "Testing external ping fallback..."
        timeout 10s ./bin/deadman-go example/deadman.sample.conf -no-ui || true

    - name: Cross-compile verification
      run: |
        # Verify we can cross-compile from macOS
        GOOS=linux GOARCH=amd64 go build -o deadman-go-linux .
        GOOS=windows GOARCH=amd64 go build -o deadman-go-windows.exe .
        
        echo "Cross-compilation successful:"
        ls -la deadman-go-*