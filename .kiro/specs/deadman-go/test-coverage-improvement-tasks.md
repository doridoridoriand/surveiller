# テストカバレッジ向上タスクリスト

## 現在のテストカバレッジ状況

### 既存のテストカバレッジ
- **config**: 83.5% (プロパティテスト + 単体テスト完備)
- **scheduler**: 81.0% (プロパティテスト + 単体テスト完備)  
- **state**: 84.1% (単体テストのみ)
- **cli**: 0.0% (テストなし)
- **metrics**: 0.0% (テストなし)
- **ping**: 0.0% (テストなし)
- **ui**: 0.0% (テストなし)
- **main**: 0.0% (テストなし)

### 不足している正確性プロパティテスト

設計書で定義された18個の正確性プロパティのうち、以下が未実装：

- プロパティ 5: ping 結果の状態更新 (state パッケージ)
- プロパティ 6: タイムアウト処理 (ping パッケージ)
- プロパティ 7: TUI グループ表示 (ui パッケージ)
- プロパティ 8: TUI RTT バーグラフ表示 (ui パッケージ)
- プロパティ 9: TUI 状態更新の即時反映 (ui パッケージ)
- プロパティ 14: 動的設定更新 (state パッケージ)
- プロパティ 15: 設定リロードエラー処理 (main パッケージ)
- プロパティ 16: 履歴保持 (state パッケージ)
- プロパティ 17: 構造化ログ出力 (main パッケージ)

## 優先度別タスクリスト

### 高優先度: 0%カバレッジのコアコンポーネント

- [x] 1. ping パッケージのテスト実装
- [x] 1.1 ICMP Pinger の単体テスト
  - ICMP ping の成功/失敗ケース
  - IPv4/IPv6 アドレス解決テスト
  - ネットワークエラーハンドリング
  - _要件: 2.1, 2.2_

- [x] 1.2 External Pinger の単体テスト
  - 外部 ping コマンド実行テスト
  - RTT パース機能テスト
  - コマンド実行エラーハンドリング
  - _要件: 2.1, 2.2_

- [x] 1.3 Fallback Pinger の単体テスト
  - ICMP 権限エラー時のフォールバック動作
  - プライマリ/セカンダリ pinger の切り替え
  - _要件: 7.5_

- [x] 1.4 タイムアウト処理のプロパティテスト
  - **プロパティ 6: タイムアウト処理**
  - **検証対象: 要件 2.5**

- [ ] 2. CLI パッケージのテスト実装
- [ ] 2.1 CLI フラグ処理の単体テスト
  - Duration フラグの解析テスト
  - MetricsMode フラグの解析テスト
  - Bool フラグの解析テスト
  - 無効な値のエラーハンドリング
  - _要件: 8.1, 8.2, 8.3, 8.4, 8.5_

- [ ] 3. metrics パッケージのテスト実装
- [ ] 3.1 メトリクス出力の単体テスト
  - Prometheus 形式のメトリクス生成
  - per-target モードのメトリクス出力
  - aggregated モードのメトリクス出力
  - both モードのメトリクス出力
  - ラベルエスケープ機能
  - _要件: 6.1, 6.2_

- [ ] 3.2 HTTP サーバーの単体テスト
  - メトリクスエンドポイントのレスポンス
  - サーバー起動/停止処理
  - エラーハンドリング

### 中優先度: 不足している正確性プロパティテスト

- [ ] 4. state パッケージのプロパティテスト追加
- [ ]* 4.1 ping 結果状態更新のプロパティテスト
  - **プロパティ 5: ping 結果の状態更新**
  - **検証対象: 要件 2.2, 2.3, 2.4**

- [ ]* 4.2 動的設定更新のプロパティテスト
  - **プロパティ 14: 動的設定更新**
  - **検証対象: 要件 5.2, 5.3**

- [ ]* 4.3 履歴保持のプロパティテスト
  - **プロパティ 16: 履歴保持**
  - **検証対象: 要件 5.5**

- [ ] 5. ui パッケージのテスト実装
- [ ] 5.1 TUI レンダリングの単体テスト
  - ターゲット情報表示のテスト
  - RTT フォーマット機能のテスト
  - 状態スタイル適用のテスト
  - 設定情報表示のテスト
  - _要件: 3.1_

- [ ] 5.2 グループ表示機能の単体テスト
  - グループ分類ロジックのテスト
  - グループボックス描画のテスト
  - _要件: 3.2_

- [ ]* 5.3 TUI グループ表示のプロパティテスト
  - **プロパティ 7: TUI グループ表示**
  - **検証対象: 要件 3.2**

- [ ] 5.4 RTT バーグラフ表示の単体テスト
  - バーグラフ生成ロジックのテスト
  - スケール計算のテスト
  - _要件: 3.3_

- [ ]* 5.5 TUI RTT バーグラフ表示のプロパティテスト
  - **プロパティ 8: TUI RTT バーグラフ表示**
  - **検証対象: 要件 3.3**

- [ ]* 5.6 TUI 状態更新のプロパティテスト
  - **プロパティ 9: TUI 状態更新の即時反映**
  - **検証対象: 要件 3.4**

### 低優先度: 統合テストとエンドツーエンドテスト

- [ ] 6. main パッケージの統合テスト
- [ ] 6.1 アプリケーション初期化の単体テスト
  - CLI オプション解析とオーバーライド処理
  - 設定ファイル読み込み処理
  - コンポーネント初期化処理
  - _要件: 全体統合_

- [ ] 6.2 シグナルハンドリングの単体テスト
  - SIGHUP による設定リロード
  - SIGINT/SIGTERM による適切な終了
  - _要件: 5.1, 4.4_

- [ ]* 6.3 設定リロードエラー処理のプロパティテスト
  - **プロパティ 15: 設定リロードエラー処理**
  - **検証対象: 要件 5.4**

- [ ]* 6.4 構造化ログ出力のプロパティテスト
  - **プロパティ 17: 構造化ログ出力**
  - **検証対象: 要件 6.1, 6.2, 6.3, 6.4, 6.5**

- [ ] 7. エンドツーエンド統合テスト
- [ ] 7.1 設定ファイルから監視開始までの統合テスト
  - 設定ファイル読み込み → スケジューラー起動 → ping 実行の流れ
  - _要件: 1.1, 2.1, 4.1_

- [ ] 7.2 TUI とバックエンドの統合テスト
  - 状態更新 → TUI 表示更新の流れ
  - キーボード入力処理
  - _要件: 3.1, 3.4, 3.5_

- [ ] 7.3 設定リロードの統合テスト
  - SIGHUP → 設定再読み込み → 監視更新の流れ
  - _要件: 5.1, 5.2, 5.3_

### 特別タスク: テストカバレッジ向上のための改善

- [ ] 8. テストカバレッジ測定とレポート改善
- [ ] 8.1 カバレッジレポートの自動生成
  - HTML カバレッジレポートの CI 統合
  - カバレッジ閾値の設定（目標: 85%以上）

- [ ] 8.2 未カバー部分の特定と対応
  - エラーハンドリング分岐のテスト追加
  - エッジケースのテスト追加

- [ ] 8.3 テストヘルパー関数の整備
  - モック pinger の改善
  - テスト用設定ファイル生成ヘルパー
  - テスト用 TUI 環境の構築

## 実装ガイドライン

### プロパティベーステスト
- **使用ライブラリ**: `gopter`
- **最低反復回数**: 100回
- **タグ形式**: `**Feature: deadman-go, Property {number}: {property_text}**`

### 単体テスト
- **テストファイル命名**: `*_test.go`
- **カバレッジ目標**: 各パッケージ85%以上
- **モック使用**: 外部依存（ネットワーク、ファイルシステム）のみ

### 統合テスト
- **テスト環境**: 一時ディレクトリとモックサーバー使用
- **テスト範囲**: コンポーネント間の連携動作
- **実行時間**: 各テスト5秒以内

## 期待される効果

このタスクリストを完了することで：

1. **全体カバレッジ**: 31.8% → 85%以上に向上
2. **品質保証**: 18個の正確性プロパティすべてをテストで検証
3. **回帰防止**: CI/CD での自動テスト実行による品質維持
4. **保守性向上**: テストによる仕様の明文化と変更時の安全性確保

## 注意事項

- `*` マークのタスクはプロパティベーステストのため、実行時間が長くなる可能性があります
- ネットワーク関連のテストは適切なモックを使用し、実際のネットワーク通信は避けてください
- TUI のテストは tcell のテスト機能を活用し、実際の端末出力は避けてください